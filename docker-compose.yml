services:
  surrealdb:
    image: surrealdb/surrealdb:v2
    command: start --log info --user root --pass root rocksdb:/mydata/mydatabase.db
    user: root  # Required for bind mounts on Linux
    ports:
      - "8000:8000"
    volumes:
      - ./surreal_data:/mydata
    environment:
      - SURREAL_EXPERIMENTAL_GRAPHQL=true
    restart: always
    pull_policy: always

  open_notebook:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8502:8502"  # Web UI
      - "5055:5055"  # Unified REST API (Main + LKS)
    environment:
      # REQUIRED: Change this to your own secret string
      # This encrypts your API keys in the database
      - OPEN_NOTEBOOK_ENCRYPTION_KEY=jackey-open-notebook-secret-2026

      # Database connection (default values - no need to change)
      - SURREAL_URL=ws://surrealdb:8000/rpc
      - SURREAL_USER=root
      - SURREAL_PASSWORD=root
      - SURREAL_NAMESPACE=open_notebook
      - SURREAL_DATABASE=open_notebook

      # Living Knowledge System Database (PostgreSQL)
      - LIVING_DB_HOST=living_postgres
      - LIVING_DB_PORT=5432
      - LIVING_DB_NAME=living_system
      - LIVING_DB_USER=living
      - LIVING_DB_PASSWORD=living

      # AI Provider API Keys (auto-initialized on startup)
      # DeepSeek - https://platform.deepseek.com
      - DEEPSEEK_API_KEY=sk-2b3e736d87754216bc509c8595292931
      # 阿里云百炼 (通义千问) - https://bailian.console.aliyun.com
      - DASHSCOPE_API_KEY=sk-383049091d584eb3aad3e0de423a3119
      # Moonshot (Kimi) - https://platform.moonshot.cn
      - MOONSHOT_API_KEY=sk-VqWRgeDnKXIED8kijgueo6jscY9Y5uHTXLWXpOt0Bi6FURzy
    volumes:
      - ./notebook_data:/app/data
      # Mount local code changes for development
      - ./open_notebook/skills:/app/open_notebook/skills
      - ./open_notebook/workflows:/app/open_notebook/workflows
      - ./open_notebook/ai/key_provider.py:/app/open_notebook/ai/key_provider.py
      - ./open_notebook/domain/skill.py:/app/open_notebook/domain/skill.py
      - ./open_notebook/domain/workflow.py:/app/open_notebook/domain/workflow.py
      - ./api/main.py:/app/api/main.py
      - ./api/routers:/app/api/routers
      - ./scripts/install-deps.sh:/app/scripts/install-deps.sh
    # Install dependencies on startup, then run the original command
    command: >
      bash -c "chmod +x /app/scripts/install-deps.sh &&
               /app/scripts/install-deps.sh &&
               /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf"
    depends_on:
      - surrealdb
      - living_postgres
    restart: always
    pull_policy: always

  # Living Knowledge System PostgreSQL Database
  living_postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=living
      - POSTGRES_PASSWORD=living
      - POSTGRES_DB=living_system
    ports:
      - "5433:5432"  # Exposed on host port 5433 to avoid conflicts
    volumes:
      - ./living_postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    restart: always
