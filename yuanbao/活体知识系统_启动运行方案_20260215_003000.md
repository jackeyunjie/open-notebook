# æ´»ä½“çŸ¥è¯†ç³»ç»Ÿ - å¯åŠ¨è¿è¡Œæ–¹æ¡ˆ (é€‰é¡¹A)

## ç›®æ ‡
è®©æ´»ä½“çŸ¥è¯†ç³»ç»ŸçœŸæ­£è·‘èµ·æ¥ï¼Œå¯æ¼”ç¤ºã€å¯æµ‹è¯•ã€å¯è¿­ä»£ã€‚

---

## éœ€è¦è¡¥é½çš„åŸºç¡€è®¾æ–½

### 1. å¯åŠ¨è„šæœ¬

```python
# open_notebook/skills/living/launcher.py
"""æ´»ä½“çŸ¥è¯†ç³»ç»Ÿå¯åŠ¨å™¨ - è®©ç³»ç»ŸçœŸæ­£è·‘èµ·æ¥"""

import asyncio
from loguru import logger

class LivingSystemLauncher:
    """æ´»ä½“çŸ¥è¯†ç³»ç»Ÿå¯åŠ¨å™¨"""
    
    async def launch(self):
        """å¯åŠ¨å®Œæ•´ç³»ç»Ÿ"""
        logger.info("ğŸš€ å¯åŠ¨æ´»ä½“çŸ¥è¯†ç³»ç»Ÿ...")
        
        # 1. åˆå§‹åŒ–ç»ç»œç³»ç»Ÿ (æ¶ˆæ¯æ€»çº¿)
        self.meridian_system = await self._init_meridians()
        logger.info("âœ… ç»ç»œç³»ç»Ÿå°±ç»ª")
        
        # 2. åˆå§‹åŒ–ç©´ä½ç½‘å…³ (APIæ¥å£)
        self.acupoint_server = await self._init_acupoints()
        logger.info("âœ… ç©´ä½ç½‘å…³å°±ç»ª")
        
        # 3. åŠ è½½å™¨å®˜ (P0/P1/P2/P3)
        self.organs = await self._load_organs()
        logger.info(f"âœ… å·²åŠ è½½ {len(self.organs)} ä¸ªå™¨å®˜")
        
        # 4. å¯åŠ¨ç”Ÿç‰©èŠ‚å¾‹è°ƒåº¦å™¨
        self.rhythm_scheduler = await self._start_rhythm()
        logger.info("âœ… ç”Ÿç‰©èŠ‚å¾‹è°ƒåº¦å™¨è¿è¡Œä¸­")
        
        # 5. å¯åŠ¨å¥åº·ç›‘æ§
        self.health_monitor = asyncio.create_task(self._health_monitor())
        logger.info("âœ… å¥åº·ç›‘æ§å¯åŠ¨")
        
        logger.info("ğŸ‰ æ´»ä½“çŸ¥è¯†ç³»ç»Ÿå·²å…¨é¢å¯åŠ¨!")
        
    async def _init_meridians(self):
        """åˆå§‹åŒ–ç»ç»œç³»ç»Ÿ"""
        from open_notebook.skills.living.meridian_flow import MeridianSystem
        
        system = MeridianSystem()
        
        # åˆ›å»ºæ ¸å¿ƒç»ç»œ
        await system.create_meridian("perception", FlowType.DATA)
        await system.create_meridian("judgment", FlowType.DATA)
        await system.create_meridian("relationship", FlowType.DATA)
        await system.create_meridian("control", FlowType.CONTROL)
        await system.create_meridian("temporal", FlowType.TEMPORAL)
        
        return system
    
    async def _init_acupoints(self):
        """åˆå§‹åŒ–ç©´ä½ç½‘å…³"""
        from open_notebook.skills.living.acupoint_trigger import AcupointServer
        
        server = AcupointServer(port=8888)
        await server.start()
        
        return server
    
    async def _load_organs(self):
        """åŠ è½½å™¨å®˜ç³»ç»Ÿ"""
        from open_notebook.skills.living.examples.p0_perception_organ import create_p0_organ
        
        organs = {}
        
        # P0 æ„ŸçŸ¥å™¨å®˜
        organs["p0"] = await create_p0_organ(self.meridian_system)
        
        # TODO: P1, P2, P3
        
        return organs
    
    async def _start_rhythm(self):
        """å¯åŠ¨ç”Ÿç‰©èŠ‚å¾‹è°ƒåº¦"""
        from open_notebook.skills.living.rhythm_scheduler import BiologicalRhythmScheduler
        
        scheduler = BiologicalRhythmScheduler()
        await scheduler.start()
        
        # æ³¨å†Œå™¨å®˜èŠ‚å¾‹
        for organ_name, organ in self.organs.items():
            scheduler.register_organ(organ_name, organ)
        
        return scheduler
    
    async def _health_monitor(self):
        """å¥åº·ç›‘æ§å¾ªç¯"""
        while True:
            await asyncio.sleep(30)  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            
            for organ_name, organ in self.organs.items():
                status = organ.get_health_status()
                if status != "healthy":
                    logger.warning(f"âš ï¸ {organ_name} çŠ¶æ€å¼‚å¸¸: {status}")


# å¯åŠ¨å…¥å£
if __name__ == "__main__":
    launcher = LivingSystemLauncher()
    asyncio.run(launcher.launch())
```

---

### 2. APIç«¯ç‚¹ (FastAPI)

```python
# open_notebook/skills/living/api_server.py
"""æ´»ä½“çŸ¥è¯†ç³»ç»ŸAPI - ç©´ä½æ¥å£"""

from fastapi import FastAPI, HTTPException
from pydantic import BaseModel

app = FastAPI(title="æ´»ä½“çŸ¥è¯†ç³»ç»Ÿ API", version="1.0.0")

# å…¨å±€ç³»ç»Ÿå¼•ç”¨
living_system = None

@app.on_event("startup")
async def startup():
    """å¯åŠ¨æ—¶åˆå§‹åŒ–ç³»ç»Ÿ"""
    from open_notebook.skills.living.launcher import LivingSystemLauncher
    
    global living_system
    launcher = LivingSystemLauncher()
    await launcher.launch()
    living_system = launcher

# === ç©´ä½æ¥å£ ===

@app.get("/health")
async def health_check():
    """ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    return {
        "status": "alive",
        "organs": {
            name: organ.get_health_status()
            for name, organ in living_system.organs.items()
        },
        "meridians": living_system.meridian_system.get_flow_stats()
    }

@app.post("/acupoint/{organ_name}/activate")
async def activate_organ(organ_name: str, input_data: dict):
    """æ¿€æ´»æŒ‡å®šå™¨å®˜ (è¾“å…¥ç©´ä½)"""
    if organ_name not in living_system.organs:
        raise HTTPException(404, f"å™¨å®˜ {organ_name} ä¸å­˜åœ¨")
    
    organ = living_system.organs[organ_name]
    result = await organ.activate(input_data)
    
    return {"organ": organ_name, "result": result}

@app.get("/acupoint/{organ_name}/state")
async def get_organ_state(organ_name: str):
    """è·å–å™¨å®˜çŠ¶æ€ (çŠ¶æ€ç©´ä½)"""
    if organ_name not in living_system.organs:
        raise HTTPException(404, f"å™¨å®˜ {organ_name} ä¸å­˜åœ¨")
    
    organ = living_system.organs[organ_name]
    return organ.get_full_state()

@app.get("/meridians/flows")
async def get_meridian_flows():
    """è·å–ç»ç»œæµé‡ç»Ÿè®¡"""
    return living_system.meridian_system.get_all_flows()

@app.post("/rhythm/trigger")
async def trigger_rhythm(organ_name: str, phase: str):
    """æ‰‹åŠ¨è§¦å‘å™¨å®˜èŠ‚å¾‹"""
    scheduler = living_system.rhythm_scheduler
    await scheduler.trigger_phase(organ_name, phase)
    return {"triggered": True, "organ": organ_name, "phase": phase}
```

---

### 3. DOKERé…ç½®

```dockerfile
# Dockerfile.living
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY open_notebook/skills/living ./open_notebook/skills/living

# æš´éœ²ç«¯å£
EXPOSE 8888

# å¯åŠ¨å‘½ä»¤
CMD ["python", "-m", "open_notebook.skills.living.launcher"]
```

```yaml
# docker-compose.living.yml
version: '3.8'

services:
  living-system:
    build:
      context: .
      dockerfile: Dockerfile.living
    ports:
      - "8888:8888"
    environment:
      - LIVING_LOG_LEVEL=INFO
      - LIVING_RHYTHM_ENABLED=true
    volumes:
      - ./data/living:/app/data
    networks:
      - living-network
    restart: unless-stopped

  # å¯é€‰ï¼šRedisä½œä¸ºç»ç»œæ¶ˆæ¯æ€»çº¿åç«¯
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - living-network

networks:
  living-network:
    driver: bridge
```

---

### 4. æ•°æ®åº“è¿æ¥ (SQLite/PostgreSQL)

```python
# open_notebook/skills/living/database.py
"""æ´»ä½“çŸ¥è¯†ç³»ç»Ÿæ•°æ®åº“ - æŒä¹…åŒ–ç»†èƒçŠ¶æ€"""

from sqlalchemy import create_engine, Column, String, JSON, DateTime, Float
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

Base = declarative_base()

class CellStateRecord(Base):
    """ç»†èƒçŠ¶æ€è®°å½•"""
    __tablename__ = "cell_states"
    
    cell_id = Column(String, primary_key=True)
    skill_type = Column(String)
    state = Column(String)  # IDLE, RUNNING, etc.
    metabolism = Column(JSON)  # ä»£è°¢çŠ¶æ€
    last_activation = Column(DateTime)
    activation_count = Column(Integer, default=0)
    success_rate = Column(Float, default=0.0)

class MeridianFlowRecord(Base):
    """ç»ç»œæµé‡è®°å½•"""
    __tablename__ = "meridian_flows"
    
    flow_id = Column(String, primary_key=True)
    meridian_name = Column(String)
    packet_count = Column(Integer, default=0)
    avg_latency_ms = Column(Float)
    last_packet_at = Column(DateTime)

# åˆå§‹åŒ–æ•°æ®åº“
engine = create_engine("sqlite:///data/living_system.db")
Base.metadata.create_all(engine)
Session = sessionmaker(bind=engine)
```

---

## å¯åŠ¨æ­¥éª¤

### æ–¹å¼1ï¼šæœ¬åœ°å¯åŠ¨
```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. å¯åŠ¨ç³»ç»Ÿ
python -m open_notebook.skills.living.launcher

# 3. æµ‹è¯•API
curl http://localhost:8888/health
```

### æ–¹å¼2ï¼šDOKERå¯åŠ¨
```bash
# 1. æ„å»ºé•œåƒ
docker build -f Dockerfile.living -t living-system .

# 2. å¯åŠ¨
docker-compose -f docker-compose.living.yml up

# 3. æŸ¥çœ‹æ—¥å¿—
docker logs -f living-system
```

---

## éªŒè¯æ¸…å•

| æ£€æŸ¥é¡¹ | å‘½ä»¤ | é¢„æœŸç»“æœ |
|--------|------|----------|
| ç³»ç»Ÿå¯åŠ¨ | `curl /health` | status: alive |
| P0å™¨å®˜ | `curl /acupoint/p0/state` | è¿”å›å®Œæ•´çŠ¶æ€ |
| ç»ç»œæµé‡ | `curl /meridians/flows` | æ˜¾ç¤ºå„ç»ç»œç»Ÿè®¡ |
| æ‰‹åŠ¨è§¦å‘ | `POST /rhythm/trigger` | å™¨å®˜è¢«æ¿€æ´» |

---

## ä¸‹ä¸€æ­¥ (å¯åŠ¨å)

ç³»ç»Ÿè·‘èµ·æ¥åï¼Œå¯ä»¥ï¼š
1. **è§‚å¯Ÿç”Ÿç‰©èŠ‚å¾‹** - çœ‹P0æ˜¯å¦åœ¨6ç‚¹è‡ªåŠ¨æ¿€æ´»
2. **æµ‹è¯•ç»ç»œæµé‡** - çœ‹æ•°æ®æ˜¯å¦åœ¨ç»ç»œä¸­æµåŠ¨
3. **ç›‘æ§ç»†èƒå¥åº·** - çœ‹æˆåŠŸç‡ã€ç–²åŠ³åº¦å˜åŒ–
4. **æ‰‹åŠ¨è§¦å‘ç©´ä½** - é€šè¿‡APIæ¿€æ´»ç‰¹å®šå™¨å®˜

---

## TODOLIST (æ‰§è¡Œå‰ç¡®è®¤)

| äº‹é¡¹ | æ­¥éª¤ | è€—æ—¶ | å½±å“ |
|------|------|------|------|
| åˆ›å»ºå¯åŠ¨è„šæœ¬ | launcher.py | 30åˆ†é’Ÿ | æ ¸å¿ƒå…¥å£ |
| åˆ›å»ºAPIæœåŠ¡ | api_server.py | 30åˆ†é’Ÿ | å¤–éƒ¨æ¥å£ |
| DOKERé…ç½® | Dockerfile + compose | 20åˆ†é’Ÿ | éƒ¨ç½²èƒ½åŠ› |
| æ•°æ®åº“è¿æ¥ | database.py | 20åˆ†é’Ÿ | çŠ¶æ€æŒä¹…åŒ– |
| é›†æˆæµ‹è¯• | éªŒè¯æ‰€æœ‰æ¥å£ | 30åˆ†é’Ÿ | è´¨é‡ä¿è¯ |

**æ€»è®¡ï¼šçº¦2.5å°æ—¶**

è¯·ç¡®è®¤åï¼ŒClaudeå¯ä»¥å¼€å§‹å®æ–½ã€‚
