# 活体知识系统架构 (Living Knowledge System)

## 核心设计理念

将知识管理系统类比为人体组织，实现自组织、自运行的智能系统。

## 组织层级

```
┌─────────────────────────────────────────────────────────┐
│                    活体知识系统                           │
├─────────────────────────────────────────────────────────┤
│  器官层 (Organs)                                        │
│  ├── P0感知系统 (感觉器官)                               │
│  ├── P1判断系统 (大脑皮层)                               │
│  ├── P2关系系统 (运动系统)                               │
│  └── P3进化系统 (神经系统)                               │
├─────────────────────────────────────────────────────────┤
│  组织层 (Tissues/Agents)                                │
│  ├── PainScannerAgent (疼痛感知组织)                     │
│  ├── TrustBuilderAgent (信任建立组织)                    │
│  └── ...                                                │
├─────────────────────────────────────────────────────────┤
│  细胞层 (Cells/Skills)                                  │
│  ├── RssCrawlerSkill                                    │
│  ├── NoteSummarizerSkill                                │
│  └── ...                                                │
├─────────────────────────────────────────────────────────┤
│  经络层 (Meridians/Flows)                               │
│  ├── 数据流 (Data Flow)                                  │
│  ├── 控制流 (Control Flow)                               │
│  └── 时序流 (Temporal Flow)                              │
├─────────────────────────────────────────────────────────┤
│  穴位层 (Acupoints/Triggers)                            │
│  ├── Agently触发器                                       │
│  ├── 时间触发器                                          │
│  ├── 事件触发器                                          │
│  └── 手动触发器                                          │
└─────────────────────────────────────────────────────────┘
```

## 各层详解

### 1. 细胞层 (Skill)

**定义**：最基本的功能单元，可独立执行特定任务

**属性**：
- `name`: 名称（如"RssCrawler"）
- `description`: 简短描述
- `function`: 功能介绍
- `resources`: 资源脚本（代码/配置/模板）
- **temporal**: 时序属性 ⭐新增
  - `schedule`: 调度时间（cron表达式）
  - `frequency`: 执行频率
  - `duration`: 预计执行时长
  - `timeout`: 超时时间
- **lifecycle**: 生命周期属性 ⭐新增
  - `state`: 当前状态（idle/running/completed/failed）
  - `created_at`: 创建时间
  - `expires_at`: 过期时间
  - `retry_count`: 重试次数
- **dependencies**: 依赖关系 ⭐新增
  - `requires`: 前置Skill
  - `provides`: 产出数据
  - `triggers`: 触发后续Skill

### 2. 组织层 (Agent)

**定义**：由多个Skill组成的协作单元，完成特定功能

**属性**：
- `name`: Agent名称
- `skills`: 包含的Skill集合
- `coordination`: 协调机制
  - `sequence`: 执行顺序
  - `parallel`: 并行执行
  - `conditional`: 条件执行
- **temporal**: 时序属性
  - `rhythm`: 组织节律（如"daily-sync"）
  - `pulse`: 心跳检查间隔

### 3. 器官层 (System)

**定义**：由多个Agent组成的复杂系统，如P0/P1/P2/P3

**属性**：
- `name`: 系统名称
- `agents`: 包含的Agent集合
- `interactions`: 系统间交互
- **homeostasis**: 稳态维持
  - `feedback_loops`: 反馈循环
  - `adaptation`: 自适应机制

### 4. 经络层 (Flow)

**定义**：连接各层的数据流、控制流、时序流

**类型**：
- `data_meridian`: 数据经络（信息传递）
- `control_meridian`: 控制经络（指令传递）
- `temporal_meridian`: 时序经络（节律同步）

### 5. 穴位层 (Acupoint)

**定义**：外部系统接入的触发点

**类型**：
- `agently_point`: Agently集成点
- `temporal_point`: 时间触发点
- `event_point`: 事件触发点
- `manual_point`: 手动触发点

## 时序与周期模型

### 时间表达

```yaml
# 绝对时间
schedule: "2024-02-15T09:00:00Z"

# Cron表达式
schedule: "0 9 * * *"  # 每天9点

# 相对时间
schedule: "+1h"  # 1小时后
schedule: "+30m" # 30分钟后

# 周期性
frequency:
  type: "cron" | "interval" | "once"
  value: "0 */6 * * *"  # 每6小时
  timezone: "Asia/Shanghai"

# 生命周期
duration: "5m"      # 预计执行5分钟
timeout: "10m"      # 10分钟超时
expires_at: "+7d"   # 7天后过期
```

### 状态流转

```
        ┌─────────┐
   ┌───▶│  IDLE   │◀────────┐
   │    └────┬────┘         │
   │         │ invoke        │ complete/fail
   │         ▼               │
   │    ┌─────────┐          │
   └────┤ RUNNING │──────────┘
        └────┬────┘
             │ pause
             ▼
        ┌─────────┐
        │ PAUSED  │
        └────┬────┘
             │ resume
             ▼
```

## Agently集成

### 穴位定义

```python
@acupoint(
    name="content_creation",
    trigger="agently.workflow.complete",
    meridians=["data.content", "control.publish"],
    params={"quadrant": "Q1", "priority": "high"}
)
def on_content_created(event):
    # 当Agently工作流完成时触发
    pass
```

### 触发器类型

1. **时间触发器** (Temporal Trigger)
   - Cron定时
   - 延迟执行
   - 周期性任务

2. **事件触发器** (Event Trigger)
   - 数据到达
   - 状态变更
   - 外部Webhook

3. **条件触发器** (Condition Trigger)
   - 阈值触发
   - 模式匹配
   - 异常检测

4. **手动触发器** (Manual Trigger)
   - API调用
   - UI点击
   - 命令行

## 资源脚本模型

### 脚本类型

```yaml
resources:
  # Python脚本
  main:
    type: "python"
    path: "skills/my_skill/main.py"
    entry: "execute"

  # 配置模板
  config:
    type: "jinja2"
    path: "skills/my_skill/config.yaml.j2"

  # Prompt模板
  prompt:
    type: "prompt"
    path: "skills/my_skill/prompt.txt"

  # 数据文件
  data:
    type: "json"
    path: "skills/my_skill/data.json"
```

### 运行时加载

```python
class LivingSkill:
    def load_resources(self):
        for name, resource in self.resources.items():
            if resource.type == "python":
                self._load_python_script(resource)
            elif resource.type == "jinja2":
                self._load_template(resource)
            # ...
```

## 实施路线图

### Phase 1: 细胞层重构
- [ ] 重构Skill基类（时序/周期/资源）
- [ ] 创建Skill生命周期管理
- [ ] 实现依赖解析器

### Phase 2: 组织层构建
- [ ] 创建Agent类
- [ ] 实现Skill编排
- [ ] 构建Agent协调机制

### Phase 3: 经络层实现
- [ ] 数据流管道
- [ ] 时序调度器
- [ ] 事件总线

### Phase 4: 穴位层集成
- [ ] Agently适配器
- [ ] 触发器系统
- [ ] 外部API网关

### Phase 5: 器官层整合
- [ ] P0-P1-P2-P3系统重构
- [ ] 稳态维持机制
- [ ] 自适应优化
